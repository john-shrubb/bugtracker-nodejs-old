<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hello world!</title>

	<link rel="stylesheet" href="/assets/css/style.css" type="text/css" />
	<style>
        div.main-wrapper {
            padding: 15px;
        }

        #authorPFP {
            height: 30px;
            border-radius: 15px;
            display: block;
            float: left;
        }

        #author-username {
            font-family: 'Roboto', Verdana, Geneva, Tahoma, sans-serif;
            float: left;
            font-size: 1.25rem;
            height: 30px;
            line-height: 30px;
            padding-left: 5px;
        }

        #timestamp {
            color: #c2c2c2;
            line-height: 30px;
            padding-left: 20px;
        }
        p {
            font-size: 1.5rem;
        }

        button {
            width: max-content;
            display: block;
            font-family: 'Roboto', Verdana, Geneva, Tahoma, sans-serif;
            font-size: 1.25rem;
            padding: 5px;
            color: #000000;
            background: transparent;
            border: 3px solid var(--colours-orange);
        }
    </style>
	</head>
<body>
	<div class="body-wrapper">
		<div class="top-title-bar">
			<h3>View Ticket</h3>
			<h3 id="top-title-bar-username">Username</h3>
		</div>
		<div class="sidebar">
			<a href="/dashboard">Dashboard</a>
			<a href="/tickets/create">Create a Ticket</a>
			<a href="/tickets/viewall">View Tickets</a>
			<a href="/users/manage">User Management</a>
			<a href="/logout">Logout</a>
		</div>
		<div class="main-wrapper">
            <div class="ticket-content-wrapper">
                <h3 id="ticket-title">Loading title...</h3>
                <span class="author-span">
                    <img id="authorPFP" src="" referrerpolicy="no-referrer" alt="Author Profile Picture">
                    <span id="author-username">Loading author</span>
                    <span id="timestamp">Loading time...</span>
                </span>
                <p id="ticket-description">Loading ticket description...</p>
            </div>

            <div class="ticket-toolbar">
                <button onclick="deleteTicket()">Delete Ticket</button>
            </div>

            <div class="comments-wrapper">
                <input type="text" id="writeCommentTextBox" placeholder="Write a comment..." name="writeCommentTextBox">
                <button id="createCommentButton">Create</button>
                
            </div>
		</div>
	</div>

	<script src="/assets/js/updateUsername.js"></script>
    <script>
        // Grab multiple very important variables. Is supposed to access the DOM as much as
        // is required at the beginning for optimisation purposes.

        const query = new URLSearchParams(window.location.search);
        const ticketTitleElement = document.getElementById('ticket-title');
        const ticketTitleDescription = document.getElementById('ticket-description');
        const authorProfilePicture = document.getElementById('authorPFP');
        const authorUsernameSpan = document.getElementById('author-username');
        const createCommentButton = document.getElementById('createCommentButton');

        // Will be defined later on, look in the mess that is two functions inside of eachother.

        let ticketDetails;
        let authorDetails;

        // Just redirects to dashboard if there isn't a ticket ID.

        if (!query.has('ticket')) {
            window.location.replace('/dashboard');
        }

        // Get ?ticket=123 stuff from URL

        const ticketID = query.get('ticket');

        // Make a request to fetch the details of the ticket.

        const ticketRequest = new XMLHttpRequest();
        ticketRequest.open('get', '/api/tickets/get/' + ticketID);
        ticketRequest.send();
        
        // Set the title & description of the ticket

        ticketRequest.onload = () => {
            // Parse JSON response
            ticketDetails = JSON.parse(ticketRequest.responseText);

            if (ticketDetails['status'] !== 200) {
                alert('Ticket does not exist or you have insufficient permissions to access it!');
                return window.location.replace('/dashboard');
            }
            ticketDetails = ticketDetails['response'];

            // Set title and description of ticket

            ticketTitleElement.innerText = ticketDetails['title'];
            ticketTitleDescription.innerText = ticketDetails['description'];

            // Set date & time of ticket. Displays as "today" instead of a full date if it was created today.

            const createdDate = new Date(ticketDetails['created_on']); // Date of ticket creation
            const ticketDateSpan = document.getElementById('timestamp'); // The #timestamp HTML element
            if (createdDate.toDateString() === new Date().toDateString()) { // Was the ticket created today?
                ticketDateSpan.innerText = `Today at ${createdDate.getHours().toLocaleString('en-gb', { minimumIntegerDigits: 2 })}:${createdDate.getMinutes().toLocaleString('en-gb', { minimumIntegerDigits: 2 })}`;
                //                          "Today at 10:54"
            } else {
                ticketDateSpan.innerText = `${createdDate.toDateString()} at ${createdDate.getHours()}:${createdDate.getMinutes()}`
                //                         "Thu Apr 06 2023 at 10:56"
            }

            // Open a request to get the details of the author of the ticket.

            const authorRequest = new XMLHttpRequest();
            authorRequest.open('post', '/api/users/get/id');
            authorRequest.setRequestHeader('Content-Type', 'application/json');
            authorRequest.send(JSON.stringify({
                'userID': ticketDetails['user_id'],
            }));

            authorRequest.onload = () => {
                authorDetails = JSON.parse(authorRequest.responseText)['response'];

                authorUsernameSpan.innerText = authorDetails['username'] ? authorDetails['username'] : 'Deleted User'; // Set username
                authorProfilePicture.src = authorDetails['profilepic']; // Set PFP
            };
        };

        const deleteTicket = () => {
            const request = new XMLHttpRequest();
            request.open('post', '/api/tickets/delete');
            request.setRequestHeader('Content-Type', 'application/json');
            request.send(JSON.stringify({
                ticketID: ticketID,
            }));

            request.onload = () => {
                const results = JSON.parse(request.responseText);

                if (results['status'] !== 200) {
                    alert(results['response']);
                } else {
                    window.location.replace('/dashboard');
                }
            };
        };

        // Comments

        createCommentButton.addEventListener('click', () => {
            const commentContent = document.getElementById('writeCommentTextBox').value.trim();

            console.log(commentContent);

            if (!commentContent) {
                alert('Can\'t create an empty comment!');
                return;
            }

            // /api/comments/create/ticketid

            const createCommentReq = new XMLHttpRequest();
            createCommentReq.open('post', '/api/comments/create/' + ticketID);
            createCommentReq.setRequestHeader('Content-Type', 'application/json');
            createCommentReq.send(JSON.stringify({
                content: commentContent,
            }));

            createCommentReq.onload = () => {
                const createCommentResponse = JSON.parse(createCommentReq.responseText);

                if (createCommentResponse['status'] !== 200) {
                    alert(createCommentResponse['response']);
                    return;
                }

                window.location.reload();
            };
        });
    </script>
</body>
</html>