<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Hello world!</title>

	<link rel="stylesheet" href="/assets/css/style.css" type="text/css" />
	<style>
		.main-wrapper .statistics {
			display: flex;
			flex-direction: row;
		}

		.main-wrapper .statistics .stat-board {
			background: var(--colours-orange);
			color: white;
			padding: 20px;
			margin: 20px;
			text-align: center;
			border-radius: 25px;
			flex-basis: 0;
			flex-grow: 1;
		}

		.main-wrapper .statistics .stat-board span {
			font-size: 2rem;
		}

		.main-wrapper div > * {
			padding-bottom: 5px;
		}
	</style>
</head>
<body>
	<div class="top-title-bar">
		<h3>Dashboard</h3>
		<h3 id="top-title-bar-username">Username</h3>
	</div>
	<div class="sidebar">
		<a href="/dashboard">Dashboard</a>
		<a href="/tickets/create">Create a Ticket</a>
		<a href="/tickets/viewall">View Tickets</a>
		<a href="/users/manage">User Management</a>
		<a href="/logout">Logout</a>
	</div>
	<div class="body-wrapper">
		<div class="main-wrapper">
			<div class="statistics">
				<div id="openTickets" class="stat-board">
					<h4>Open<br>Tickets</h4>
					<span class="stat">0</span>
				</div>
				<div id="totalTickets" class="stat-board">
					<h4>Total<br>Tickets</h4>
					<span class="stat">0</span>
				</div>
				<div id="recentTickets" class="stat-board">
					<h4>Opened<br>Today</h4>
					<span class="stat">0</span>
				</div>
			</div>
		</div>
	</div>

	<script>
		// Everything to do with tickets

		async function getTickets() {
			return await new Promise(function (resolve) {
				const request = new XMLHttpRequest();
				request.open('get', '/api/tickets/list');
				request.send();
				request.onload = function() {
					resolve(JSON.parse(request.responseText));
				};
			});
		}

		async function updateDashboard() {
			// Total tickets visible to user

			const ticketList = await getTickets();

			document.getElementById('totalTickets').querySelector('span').innerHTML = ticketList.length;

			// Tickets opened today that are visible to user

			let totalTodayTickets = 0;

			for (const tListIndex in ticketList) {
				const date = new Date(ticketList[tListIndex]['created_on']).toDateString();
				const today = new Date().toDateString();

				if (date === today) {
					totalTodayTickets++;
				}
			}

			document.getElementById('recentTickets').querySelector('span').innerHTML = totalTodayTickets;

			// Tickets visible to user that are open

			let openTickets = 0;

			for (const tListIndex in ticketList) {
				const status = ticketList[tListIndex]['status'];

				if (status !== 3) {
					openTickets++;
				}
			}

			document.getElementById('openTickets').querySelector('span').innerHTML = openTickets;

			return true;
		}

		updateDashboard();
	</script>
	<script src="/assets/js/updateUsername.js"></script>
</body>
</html>